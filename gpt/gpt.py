import aiohttp
from models import Pet


PWD = 'true_secret_key'

# –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –≤ –æ—Ç–≤–µ—Ç–µ

CAT_PROMPT = "–ù–∞–ø–∏—à–∏ –Ω–µ–±–æ–ª—å—à–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–∞ 4 –∏–ª–∏ 6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ –ø—Ä–∏—é—Ç –æ _animal_, –∫–æ—Ç–æ—Ä_ending_ –∏—â–µ—Ç —Ö–æ–∑—è–∏–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–∏—Å–∞–Ω–∏—è. –ù–µ —É–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –∞–¥—Ä–µ—Å –ø—Ä–∏—é—Ç–∞, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ö–µ—à—Ç–µ–≥–∏:"
DOG_PROMPT = "–ù–∞–ø–∏—à–∏ –Ω–µ–±–æ–ª—å—à–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–∞ 4 –∏–ª–∏ 6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ –ø—Ä–∏—é—Ç –æ —Å–æ–±–∞–∫–µ, –∫–æ—Ç–æ—Ä–∞—è –∏—â–µ—Ç —Ö–æ–∑—è–∏–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–∏—Å–∞–Ω–∏—è. –ù–µ —É–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –∞–¥—Ä–µ—Å –ø—Ä–∏—é—Ç–∞, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ö–µ—à—Ç–µ–≥–∏:"

DOG_1 = """
    new_description
üê∂ –ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –º–∞–ª—å—á–∏–∫ –∏—â–µ—Ç —Å–≤–æ–µ–≥–æ –ø—É—à–∏—Å—Ç–æ–≥–æ –∫–æ–º–ø–∞–Ω—å–æ–Ω–∞! üíï

üåü –≠—Ç–æ—Ç –æ—á–∞—Ä–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø–µ—Å–∏–∫ - –º–∞–ª–µ–Ω—å–∫–∏–π –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π –∫—Ä–∞—Å–∞–≤—á–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –æ–±–æ–∂–∞–µ—Ç –∏–≥—Ä–∞—Ç—å –≤ –º—è—á–∏–∫ –∏ –≥—É–ª—è—Ç—å –Ω–∞ –ø—Ä–æ–≥—É–ª–∫–∞—Ö! üéæüèûÔ∏è

‚ú®–û–Ω —É–∂–µ –ø—Ä–∏—É—á–µ–Ω –∫ –ª–æ—Ç–∫—É –∏ –±—É–¥–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–º –¥—Ä—É–≥–æ–º –¥–ª—è —Ü–µ–ª–æ–π —Å–µ–º—å–∏! –ú—è–≥–∫–∏–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–ª–æ–Ω –ª—é–±–≤–∏ ü§ó

üë™–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–º—É –∏ –¥—É—à–µ–≤–Ω–æ–µ —Ç–µ–ø–ª–æ —ç—Ç–æ–º—É –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ–º—É –º–∞–ª—ã—à—É, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏! üìûüìß

üíê–û–Ω –∂–¥–µ—Ç –∏—Å–∫—Ä–µ–Ω–Ω–µ–π –ª—é–±–≤–∏ –∏ –∑–∞–±–æ—Ç—ã! –ü–æ–º–æ–≥–∏—Ç–µ —ç—Ç–æ–π —á—É–¥–µ—Å–Ω–æ–π —Å–æ–±–∞—á–∫–µ –Ω–∞–π—Ç–∏ –¥–æ–ª–≥–æ–∂–¥–∞–Ω–Ω–æ–µ —Å—á–∞—Å—Ç—å–µ! üè°üíñ
"""

CAT_1 = """
üê±‚ù§Ô∏è –û–±—ä—è–≤–ª–µ–Ω–∏–µ! –ò—â–µ–º –¥–æ–º –¥–ª—è –Ω–∞—à–µ–≥–æ –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ—Ç–∏–∫–∞! üè†üè°

–≠—Ç–æ—Ç –º–∏–ª—ã–π –º–∞–ª—å—á–∏–∫ - –Ω–∞—Å—Ç–æ—è—â–∞—è –Ω–∞—Ö–æ–¥–∫–∞! –û–Ω –æ—á–µ–Ω—å –ª–∞—Å–∫–æ–≤—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π üòªüíï, –≥–æ—Ç–æ–≤ —Å—Ç–∞—Ç—å –≤–µ—Ä–Ω—ã–º –¥—Ä—É–≥–æ–º –Ω–∞ –≤—Å—é –∂–∏–∑–Ω—å. –ö —Ç–æ–º—É –∂–µ, –æ–Ω —É–∂–µ –ø—Ä–∏—É—á–µ–Ω –∫ –ª–æ—Ç–∫—É üöΩ, —Ç–∞–∫ —á—Ç–æ –ø—Ä–æ–±–ª–µ–º —Å —É—Ö–æ–¥–æ–º –∑–∞ –Ω–∏–º –Ω–µ –±—É–¥–µ—Ç. 

–ö–æ—Ç–∏–∫ –∏–º–µ–µ—Ç –∫–æ—Ä–∏—á–Ω–µ–≤—É—é —à–µ—Ä—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç—Ä—è—Å–∞—é—â–µ! üçÇüå∞ –£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –µ–≥–æ –æ–∫—Ä–∞—Å –ø–æ–¥—á–µ—Ä–∫–Ω–µ—Ç —É—é—Ç –∏ —Ç–µ–ø–ª–æ—Ç—É –≤–∞—à–µ–≥–æ –¥–æ–º–∞.

–ï—Å–ª–∏ –≤—ã –∏—â–µ—Ç–µ –Ω–æ–≤–æ–≥–æ –ø—É—à–∏—Å—Ç–æ–≥–æ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ä–∞–¥–æ–≤–∞—Ç—å –≤–∞—Å —Å–≤–æ–µ–π –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç—å—é, —Ç–æ —ç—Ç–æ—Ç –∫–æ—Ç–∏–∫ - –∏–¥–µ–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä! üíñ

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ –≤ –Ω–∞—à –ø—Ä–∏—é—Ç –∏ –≤—Å—Ç—Ä–µ—Ç—å—Ç–µ—Å—å —Å —ç—Ç–∏–º –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–º –ø–∏—Ç–æ–º—Ü–µ–º. –û–Ω –∂–¥–µ—Ç –∏—Å–∫—Ä–µ–Ω–Ω–µ–≥–æ –∏ –∑–∞–±–æ—Ç–ª–∏–≤–æ–≥–æ —Ö–æ–∑—è–∏–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π –¥–∞—Å—Ç –µ–º—É —Å–≤–æ—é –ª—é–±–æ–≤—å –∏ –ª–∞—Å–∫—É. üè†‚ù§Ô∏è

–ü–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –∏—Å—Ç–∏–Ω–Ω–æ–µ —Å—á–∞—Å—Ç—å–µ –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å—Å—è —Å –Ω–∞—à–µ–≥–æ –º–∞–ª–µ–Ω—å–∫–æ–≥–æ –∫–æ—Ç–∏–∫–∞. –£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –æ–Ω —Å—Ç–∞–Ω–µ—Ç –≤–∞—à–∏–º –Ω–∞—Å—Ç–æ—è—â–∏–º –¥—Ä—É–≥–æ–º! üêæüòä
"""


def _get_prompt(pet: Pet):
    if pet.pet_type == 'cat':
        if pet.gender in ['–º–∞–ª—å—á–∏–∫', '–º—É–∂—Å–∫–æ–π']:
            prompt = CAT_PROMPT.replace('_animal_', '–∫–æ—Ç–µ')
            prompt = prompt.replace('_ending_', '—ã–π')
        else:
            prompt = CAT_PROMPT.replace('_animal_', '–∫–æ—à–∫–µ')
            prompt = prompt.replace('_ending_', '–∞—è')
    else:
        prompt = DOG_PROMPT

    # prompt = prompt + f' –ø–æ–ª: {pet.gender}, ' 
    # if pet.name is not None:
    #     prompt += f' –∫–ª–∏—á–∫–∞ {pet.name}, '
    # if pet.age is not None:
    #     prompt += f' –≤–æ–∑—Ä–∞—Å—Ç {pet.age}, '
        

    prompt = prompt + pet.prompt
        #prompt = CAT_PROMPT + '\n' + user_prompt
    # else:
    #     if pet.gender in ['–º–∞–ª—å—á–∏–∫', '–º—É–∂—Å–∫–æ–π']:
    #         prompt = CAT_PROMPT.replace('_animal_', '—Å–æ–±–∞–∫–µ')
    #         prompt = prompt.replace('_ending_', '—ã–π')
    #     else:
    #         prompt = CAT_PROMPT.replace('_animal_', '—Å–æ–±–∞–∫–µ')
    #         prompt = prompt.replace('_ending_', '–∞—è')

    print(f'PROMPT = {prompt}')
    return prompt


def get_prompt(pet: Pet):
    template = "–ù–∞–ø–∏—à–∏ –Ω–µ–±–æ–ª—å—à–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–∏—é—Ç –æ __animal__ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–∏—Å–∞–Ω–∏—è. –ù–µ —É–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∞–¥—Ä–µ—Å –ø—Ä–∏—é—Ç–∞ –∏ –∏–º—è –∂–∏–≤–æ—Ç–Ω–æ–≥–æ, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ö–µ—à—Ç–µ–≥–∏: __gender__"
    if pet.pet_type == 'cat':
        if pet.gender == '–º–∞–ª—å—á–∏–∫':  
            prompt = template.replace('__animal__', '–∫–æ—Ç–µ').replace('__gender__', '—Ö–æ—Ä–æ—à–∏–π –º–∞–ª—å—á–∏–∫')
        else:
            prompt = template.replace('__animal__', '–∫–æ—à–∫–µ').replace('__gender__', '—Ö–æ—Ä–æ—à–∞—è –¥–µ–≤–æ—á–∫–∞')
    else:
        if pet.gender == '–º–∞–ª—å—á–∏–∫': 
            prompt = template.replace('__animal__', '—Å–æ–±–∞–∫–µ').replace('__gender__', '—Ö–æ—Ä–æ—à–∏–π –º–∞–ª—å—á–∏–∫')
        else:
            prompt = template.replace('__animal__', '—Å–æ–±–∞–∫–µ').replace('__gender__', '—Ö–æ—Ä–æ—à–∞—è –¥–µ–≤–æ—á–∫–∞')
    print(f'PROMPT = {prompt}')
    print('\n')
    prompt = prompt + ' ' + pet.prompt
    return prompt

# async def make_description(user_prompt: str, pet_type: str, smiles: bool = True):
async def make_description(pet: Pet, smiles: bool = True):
    # return DOG_1
    URL = 'http://162.248.227.166:4000/get_gpt_response'
    try:
        prompt = get_prompt(pet)
        async with aiohttp.ClientSession() as session:
            async with session.post(URL, json={"prompt": prompt, 'password': PWD}) as response:
                json = await response.json()
                if int(json.get('status')) == 200:
                    return json.get('description').replace('\n\n', '\n')
                else:
                    return None
                
    except Exception as e:
        print(f'Exception: {e}')
        if pet.pet_type == 'cat':
            prompt = CAT_1
        else:
            prompt = DOG_1

        return prompt